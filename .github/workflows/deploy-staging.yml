name: Deploy to Staging

on:
  push:
    branches:
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Sync Database from Production
        env:
          SOURCE_APPWRITE_ENDPOINT: ${{ secrets.PROD_APPWRITE_ENDPOINT || secrets.NEXT_PUBLIC_APPWRITE_ENDPOINT }}
          SOURCE_APPWRITE_PROJECT_ID: ${{ secrets.PROD_PROJECT_ID }}
          SOURCE_APPWRITE_API_KEY: ${{ secrets.PROD_API_KEY }}
          NEXT_PUBLIC_APPWRITE_ENDPOINT: ${{ secrets.NEXT_PUBLIC_APPWRITE_ENDPOINT }}
          NEXT_PUBLIC_APPWRITE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
        run: npx tsx scripts/sync-staging.ts
        continue-on-error: true # Don't block deploy if sync fails

      - name: Sync Discord Commands
        env:
          DISCORD_APP_ID: ${{ secrets.DISCORD_APP_ID }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
        run: |
          if ! npm run discord:register; then
            echo "### âš ï¸ Discord Command Sync Failed" >> $GITHUB_STEP_SUMMARY
            echo "The command synchronization failed, but the deployment is proceeding." >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Build with staging env vars
        env:
          NEXT_PUBLIC_APPWRITE_ENDPOINT: ${{ secrets.NEXT_PUBLIC_APPWRITE_ENDPOINT }}
          NEXT_PUBLIC_APPWRITE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
        run: npm run build

      - name: Setup Appwrite CLI
        run: |
          npm install -g appwrite-cli
          appwrite client --endpoint ${{ secrets.NEXT_PUBLIC_APPWRITE_ENDPOINT }} --project-id ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_ID }} --key ${{ secrets.APPWRITE_API_KEY }}

      - name: Deploy to Appwrite Sites
        run: |
          echo "ðŸš€ Deploying to staging..."
          # Note: appwrite push sites requires appwrite.json or explicit site-id.
          # If appwrite.json is missing, this might fail or require additional flags.
          OUTPUT=$(appwrite push sites 2>&1 | tee /dev/tty)
          if echo "$OUTPUT" | grep -q "No sites found"; then
            echo "Deployment failed: No sites found"
            exit 1
          fi
