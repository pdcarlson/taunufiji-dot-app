# Internal OS (Tau Nu Fiji)

The secure internal dashboard for the Tau Nu Chapter of Phi Gamma Delta. Built with Next.js 14, Appwrite, and Discord Auth.

## Features

### Authentication

- **Discord SSO:** Users log in via Discord (`AuthService.syncUser`).
- **Role-Based Access:** "Brothers" (Discord Role) gain access to protected routes.
- **Role-Based Access:** "Brothers" (Discord Role) gain access to protected routes.
- **Session Management:** Handled via Appwrite Sessions and stored cookies.

## âš¡ Technology Stack

- **Framework**: [Next.js 14](https://nextjs.org/) (App Router, Server Actions)
- **Database & Auth**: [Appwrite Cloud](https://appwrite.io/) (v1.6+)
- **Storage**: AWS S3 (via Appwrite Storage or Direct, historically) -> _Actually using Appwrite Storage now_? Wait, code says `StorageService` uses S3 Direct in `library.service.ts`? _Let me check `s3.service.ts` if it exists, or if `StorageService` is the wrapper. Yes, `LibraryService` calls `StorageService.getReadUrl`. I will verify._
- **Styling**: [Tailwind CSS](https://tailwindcss.com/) + [shadcn/ui](https://ui.shadcn.com/)
- **Icons**: [Lucide React](https://lucide.dev/)

## ðŸ—ï¸ Architecture Patterns

### Service Layer Pattern (`lib/services/`)

We strictly separate **Server Actions** (Data Access / Auth Guards) from **Business Logic**.

- **Services** (`auth.service.ts`, `tasks.service.ts`): Contain pure Appwrite Node SDK calls. They run ONLY on the server.
- **Actions** (`lib/actions/`): Next.js Server Actions that call Services. They handle:
  1.  **Authentication**: Verifying the user session or API Key.
  2.  **Authorization**: Calling `AuthService.verifyBrother` (RBAC).
  3.  **Response Formatting**: Returning clean DTOs to the client.

### âš ï¸ Data Architecture & ID Strategy

This application uses **Random Strings (`ID.unique()`)** as the Primary Keys (Document IDs) for the `users` collection to prevent database corruption / "Ghost ID" issues.

- **Document ID (`$id`)**: Randomly generated by Appwrite (Internal Use Only).
- **Discord ID (`discord_id`)**: Stored as a **Unique Attribute**. Used for all business logic lookups.

**CONSEQUENCE:** When querying user data, you **MUST NOT** assume `user.$id` is the Discord ID.

- **Incorrect:** `db.getDocument(DB_ID, COLLECTIONS.USERS, discordId)` (Will 404)
- **Correct:** `db.listDocuments(..., [Query.equal("discord_id", discordId)])`

### ðŸ  Housing Dashboard (v2)

- **Goal:** Manage house chores, recurring schedules, and ad-hoc bounties.
- **Features:**
  - **Recurring Schedules:** Admin creates templates (e.g., "Trash - Mondays") which auto-spawn tasks.
  - **Bounties:** Users post optional tasks with Point rewards ("Fix Door - 50pts").
  - **Assignments:** Direct assignment flow with "Time to Complete" deadlines.
- **Task State Machine:**
  - `open`: Available to be claimed (Bounty) or Assigned (Duty).
  - `pending`: Claimed/Assigned. Work in progress.
  - `pending_review`: Proof uploaded, awaiting Admin approval.
  - `approved`: Points awarded, task closed.
  - `rejected`: Proof denied. Penalty applied (if Duty) or returned to pool (if Bounty).
  - `expired`: Deadline passed. Socked with Fine (if Duty).
  - `locked`: Recurring task in cooldown period.
- **User Flow:**
  1.  Login -> Dashboard -> Housing.
  2.  **Duties:** Assigned users see tasks in "My Responsibilities". (0 Pts, -50 Pts optional fine).
  3.  **Bounties:** Open to all in "Available Bounties". (+Pts).
  4.  **Admin:** Create Schedule (Recurring) or Assign Duty (One-Off).
- **Files:** `app/dashboard/housing`, `lib/services/tasks.service.ts`.

### ðŸ“š Scholarship Library

- **Goal:** Searchable repository of past exams and notes (Answer Keys & Student Copies).
- **How it Works:**
  - Files stored in S3 (`library/` folder), metadata in Appwrite Database (`library_resources`).
  - **Upload:** Secure drag-and-drop info redactor (`PdfRedactor`) + S3 direct upload via Server Actions.
  - **Search:** Premium UI with instant filtering by Dept, Course, and Professor.
- **User Flow:**
  1.  Library -> Search ("CS 101") -> Download PDF.
  2.  Library -> Upload -> Redact -> Submit (+Points).
- **Files:** `app/dashboard/library/page.tsx`, `lib/actions/library.actions.ts`.

### ðŸ“Š Points System (Unified)

- **Goal:** Track lifetime and current points for housing picks.
- **How it Works:** Real-time sync with Appwrite `users` collection.
- **Location:** Integrated directly into the Dashboard Home (`/dashboard`) via `PointsHistory` component.
- **Files:** `components/dashboard/PointsHistory.tsx`, `lib/actions/ledger.actions.ts`.

---

## ðŸ”’ Security Model

This application uses a stricter-than-average security model to prevent unauthorized access and data leaks.

### 1. Zero-Permission Database

- **Policy:** No Appwrite Database Collection has `role:all` or `role:member` permissions enabled.
- **Access:** All data access is performed via **Server Actions** using a secret `APPWRITE_API_KEY`.
- **Reasoning:** This prevents clients from bypassing business logic or accessing other users' data via the Client SDK.

### 2. Role-Based Access Control (RBAC)

- **Source of Truth:** Discord Roles.
- **Mechanism:** `AuthService.verifyBrother` (or `verifyRole`) checks the user's active Discord roles against a Server-Side Allowed List (`lib/config/roles.ts`) before every sensitive action.
- **Fail-Secure:** Unauthorized requests receive empty data or generic errors, not partial data.

---

## ðŸ’¾ Database Schema (v2_internal_ops)

All collections use **Discord ID** as the primary correlation key where applicable.

| Collection            | Key Attributes                                                                      | Notes                         |
| :-------------------- | :---------------------------------------------------------------------------------- | :---------------------------- |
| **users**             | `discord_id`, `full_name`, `position_key`, `details_points_current`                 | Synced from Discord on Login. |
| **housing_schedules** | `active`, `recurrence_rule`, `points_value`, `assigned_to` (default)                | Templates for spawning tasks. |
| **assignments**       | `assigned_to`, `status` (`open`, `pending`, `completed`), `proof_url`, `expires_at` | Active tasks/duties.          |
| **library_resources** | `department`, `course_number`, `professor`, `file_s3_key`, `uploaded_by`            | Metadata for S3 files.        |
| **ledger**            | `user_id`, `amount`, `reason`, `category`, `timestamp`                              | Immutable history of points.  |

---

## Development

### Commands

- `npm run dev`: Start local server (ensure `.env.local` is set).
- `npm run build`: Production build.
- `npm run lint`: Check for code quality issues.

### Environment Variables

Required in `.env.local`:

- `NEXT_PUBLIC_APPWRITE_ENDPOINT`
- `NEXT_PUBLIC_APPWRITE_PROJECT_ID`
- `APPWRITE_API_KEY` (Server-side admin)
- `NEXT_PUBLIC_APPWRITE_DATABASE_ID`

<!-- TODO -->
<!-- add date validation on assigned tasks -->
<!-- add ability to edit assigned task due date and assignee -->
